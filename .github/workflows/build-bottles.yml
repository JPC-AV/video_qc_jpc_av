name: Build Bottles

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to build bottles for'
        required: true
        type: string

jobs:
  build-bottles:
    name: Build bottles
    strategy:
      matrix:
        include:
          - os: macos-14
            arch: arm64
            bottle_tag: arm64_sonoma
          - os: macos-13
            arch: x86_64
            bottle_tag: ventura
          - os: macos-12
            arch: x86_64
            bottle_tag: monterey
      fail-fast: false
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Set up Homebrew
      uses: Homebrew/actions/setup-homebrew@master
    
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ github.event.inputs.tag_name }}"
        fi
        VERSION_CLEAN=${VERSION#v}
        echo "version=${VERSION_CLEAN}" >> $GITHUB_OUTPUT
        echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Clean environment
      run: |
        # Clean up any existing Python conflicts
        brew cleanup || true
        
        # Update Homebrew
        brew update
    
    - name: Install dependencies
      run: |
        # Force remove any conflicting Python versions first
        brew uninstall --ignore-dependencies python@3.13 || true
        brew uninstall --ignore-dependencies python3 || true
        
        # Install our specific Python version
        echo "Installing python@3.10..."
        brew install python@3.10
        
        # Force link python@3.10 and make it the default
        brew unlink python@3.10 || true
        brew link --force python@3.10
        
        # Verify we're using the right Python
        echo "Python version check:"
        /usr/local/opt/python@3.10/bin/python3 --version
        /usr/local/opt/python@3.10/bin/pip3 --version
        
        echo "Installing pyqt..."
        brew install pyqt
        
        echo "Installing qt@6..."
        brew install qt@6
    
    - name: Tap repository
      run: brew tap JPC-AV/AV-Spex https://github.com/JPC-AV/homebrew-AV-Spex
    
    - name: Build bottle
      id: build
      run: |
        # Set environment to force use of python@3.10
        export PATH="/usr/local/opt/python@3.10/bin:$PATH"
        export HOMEBREW_FORCE_BREWED_PYTHON=1
        
        # Verify Python version before building
        echo "=== Python Environment ==="
        which python3
        python3 --version
        which pip3
        pip3 --version
        echo "=========================="
        
        # Build the bottle
        brew install --build-bottle JPC-AV/AV-Spex/av-spex
        brew bottle --verbose --json --root-url=https://github.com/JPC-AV/video_qc_jpc_av/releases/download/v${{ steps.version.outputs.version }} JPC-AV/AV-Spex/av-spex
        
        BOTTLE_FILE=$(ls av-spex--*.bottle.tar.gz | head -1)
        echo "bottle_file=${BOTTLE_FILE}" >> $GITHUB_OUTPUT
    
    - name: Test bottle
      run: |
        brew uninstall JPC-AV/AV-Spex/av-spex
        brew install ${{ steps.build.outputs.bottle_file }}
        av-spex --version
        av-spex --help
    
    - name: Upload bottle
      uses: actions/upload-artifact@v4
      with:
        name: bottle-${{ matrix.bottle_tag }}-v${{ steps.version.outputs.version }}
        path: |
          av-spex--*.bottle.tar.gz
          av-spex--*.bottle.json
        retention-days: 30

  update-formula:
    name: Update formula
    needs: build-bottles
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Checkout homebrew tap
      uses: actions/checkout@v4
      with:
        repository: JPC-AV/homebrew-AV-Spex
        token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        path: homebrew-tap
    
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ github.event.inputs.tag_name }}"
        fi
        VERSION_CLEAN=${VERSION#v}
        echo "version=${VERSION_CLEAN}" >> $GITHUB_OUTPUT
        echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Download bottles
      uses: actions/download-artifact@v4
      with:
        path: bottles/
    
    - name: Extract bottle info
      id: bottles
      run: |
        cd bottles/
        
        ARM64_SHA=""
        VENTURA_SHA=""
        MONTEREY_SHA=""
        
        for dir in bottle-*/; do
          if [[ -f "${dir}av-spex--"*".bottle.json" ]]; then
            JSON_FILE="${dir}av-spex--"*".bottle.json"
            
            if [[ "$dir" == *"arm64_sonoma"* ]]; then
              ARM64_SHA=$(jq -r '.["JPC-AV/AV-Spex/av-spex"].bottle.tags.arm64_sonoma.sha256' "$JSON_FILE")
            elif [[ "$dir" == *"ventura"* ]]; then
              VENTURA_SHA=$(jq -r '.["JPC-AV/AV-Spex/av-spex"].bottle.tags.ventura.sha256' "$JSON_FILE")
            elif [[ "$dir" == *"monterey"* ]]; then
              MONTEREY_SHA=$(jq -r '.["JPC-AV/AV-Spex/av-spex"].bottle.tags.monterey.sha256' "$JSON_FILE")
            fi
          fi
        done
        
        echo "arm64_sha=${ARM64_SHA}" >> $GITHUB_OUTPUT
        echo "ventura_sha=${VENTURA_SHA}" >> $GITHUB_OUTPUT
        echo "monterey_sha=${MONTEREY_SHA}" >> $GITHUB_OUTPUT
    
    - name: Update formula
      run: |
        cd homebrew-tap
        
        curl -L "https://github.com/JPC-AV/video_qc_jpc_av/archive/refs/tags/v${{ steps.version.outputs.version }}.tar.gz" -o release.tar.gz
        SOURCE_SHA256=$(sha256sum release.tar.gz | cut -d' ' -f1)
        rm release.tar.gz
        
        cat > Formula/AV-Spex.rb << 'EOF'
        class AvSpex < Formula
          include Language::Python::Virtualenv

          desc "Python project for NMAAHC media conservation lab"
          homepage "https://github.com/JPC-AV/video_qc_jpc_av"
          url "https://github.com/JPC-AV/video_qc_jpc_av/archive/refs/tags/v${{ steps.version.outputs.version }}.tar.gz"
          sha256 "${SOURCE_SHA256}"
          license "GPL-3.0-only"

          bottle do
        EOF
        
        if [[ -n "${{ steps.bottles.outputs.arm64_sha }}" && "${{ steps.bottles.outputs.arm64_sha }}" != "null" ]]; then
          echo "    sha256 cellar: :any_skip_relocation, arm64_sonoma: \"${{ steps.bottles.outputs.arm64_sha }}\"" >> Formula/AV-Spex.rb
        fi
        
        if [[ -n "${{ steps.bottles.outputs.ventura_sha }}" && "${{ steps.bottles.outputs.ventura_sha }}" != "null" ]]; then
          echo "    sha256 cellar: :any_skip_relocation, ventura: \"${{ steps.bottles.outputs.ventura_sha }}\"" >> Formula/AV-Spex.rb
        fi
        
        if [[ -n "${{ steps.bottles.outputs.monterey_sha }}" && "${{ steps.bottles.outputs.monterey_sha }}" != "null" ]]; then
          echo "    sha256 cellar: :any_skip_relocation, monterey: \"${{ steps.bottles.outputs.monterey_sha }}\"" >> Formula/AV-Spex.rb
        fi
        
        cat >> Formula/AV-Spex.rb << 'EOF'
            root_url "https://github.com/JPC-AV/video_qc_jpc_av/releases/download/v${{ steps.version.outputs.version }}"
          end

          depends_on "python@3.10"
          depends_on "pyqt"
          depends_on "qt@6"
          
          resource "setuptools" do
            url "https://files.pythonhosted.org/packages/92/ec/089608b791d210aec4e7f97488e67ab0d33add3efccb83a056cbafe3a2a6/setuptools-75.8.0.tar.gz"
            sha256 "c5afc8f407c626b8313a86e10311dd3f661c6cd9c09d4bf8c15c0e11f9f2b0e6"
          end

          resource "toml" do
            url "https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz"
            sha256 "b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f"
          end

          resource "art" do
            url "https://files.pythonhosted.org/packages/b6/15/6c4ac6bf544a01230bad5b45ce4f624051b9dc9567875da05cfdbfc2cafa/art-6.1.tar.gz"
            sha256 "6ab3031e3b7710039e73497b0e750cadfe04d4c1279ce3a123500dbafb9e1b64"
          end

          resource "colorlog" do
            url "https://files.pythonhosted.org/packages/78/6b/4e5481ddcdb9c255b2715f54c863629f1543e97bc8c309d1c5c131ad14f2/colorlog-6.7.0.tar.gz"
            sha256 "bd94bd21c1e13fac7bd3153f4bc3a7dc0eb0974b8bc2fdf1a989e474f6e582e5"
          end

          resource "appdirs" do
            url "https://files.pythonhosted.org/packages/d7/d8/05696357e0311f5b5c316d7b95f46c669dd9c15aaeecbb48c7d0aeb88c40/appdirs-1.4.4.tar.gz"
            sha256 "7d5d0167b2b1ba821647616af46a749d1c653740dd0d2415100fe26e27afdf41"
          end

          resource "lxml" do
            url "https://files.pythonhosted.org/packages/ef/f6/c15ca8e5646e937c148e147244817672cf920b56ac0bf2cc1512ae674be8/lxml-5.3.1.tar.gz"
            sha256 "106b7b5d2977b339f1e97efe2778e2ab20e99994cbb0ec5e55771ed0795920c8"
          end

          resource "plotly" do
            url "https://files.pythonhosted.org/packages/db/9e/31b2f0b8f2357cd5f3e992c76c3e4e85a5cbbad8b8c5f23d0684e3f4c608/plotly-5.23.0.tar.gz"
            sha256 "89e57d003a116303a34de6700862391367dd564222ab71f8531df70279fc0193"
          end

          def install
            venv = virtualenv_create(libexec, "python3")
            
            venv.pip_install resources.reject { |r| r.name == "plotly" || r.name == "lxml" }

            system libexec/"bin/python", "-m", "pip", "install", "--no-deps", "--only-binary", ":all:", "plotly==5.23.0"

            system libexec/"bin/python", "-m", "pip", "install", "--no-deps", "--only-binary", ":all:", "lxml==5.3.1"

            venv.pip_install_and_link buildpath
            
            bin.install_symlink libexec/"bin/av-spex"
            bin.install_symlink libexec/"bin/av-spex-gui"
          end

          test do
            system bin/"av-spex", "--version"
          end
        end
        EOF
    
    - name: Commit changes
      run: |
        cd homebrew-tap
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add Formula/AV-Spex.rb
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update AV-Spex to version ${{ steps.version.outputs.version }} with bottles"
          git push
        fi
